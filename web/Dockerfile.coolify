version: '3.8'

# =================================================================
# UPSC PrepX-AI NextJS Application Docker Compose Configuration
# =================================================================
# This docker-compose.yml provides an easier way to manage the
# NextJS application with proper environment configuration,
# port mapping, health checks, and restart policies.
# =================================================================

services:
  # Main NextJS Application
  upsc-prepx-ai:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
    container_name: upsc-prepx-ai
    restart: unless-stopped
    
    # Environment Configuration
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - PORT=3000
      - HOSTNAME=0.0.0.0
    
    # Port Mapping (configurable)
    ports:
      - "${APP_PORT:-3001}:3000"
    
    # Volume Mounts
    volumes:
      - ./logs:/app/logs
      - ./backups:/app/backups
      - ./uploads:/app/uploads
      - /app/node_modules
    
    # Health Check Configuration
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    
    # Security Configuration
    security_opt:
      - no-new-privileges:true
    user: "1001:1001"
    
    # Network Configuration
    networks:
      - app-network
    
    # Logging Configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Labels for better management
    labels:
      - "app.name=upsc-prepx-ai"
      - "app.version=latest"
      - "app.type=nextjs"
      - "managed.by=deployment-script"
    
    # Dependencies (if any)
    depends_on:
      - redis
      # - postgres
      # - mongo
    
    # Additional Configuration
    command: ["node", "server.js"]
    
    # Stop signal for graceful shutdown
    stop_signal: SIGTERM
    stop_grace_period: 30s

  # Redis Cache Service (Optional)
  redis:
    image: redis:7-alpine
    container_name: upsc-redis
    restart: unless-stopped
    
    ports:
      - "${REDIS_PORT:-6379}:6379"
    
    volumes:
      - redis-data:/data
    
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    networks:
      - app-network
    
    # Security Configuration
    security_opt:
      - no-new-privileges:true
    
    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Nginx Reverse Proxy (Optional - for production setup)
  nginx:
    image: nginx:alpine
    container_name: upsc-nginx
    restart: unless-stopped
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    
    depends_on:
      upsc-prepx-ai:
        condition: service_healthy
    
    networks:
      - app-network
    
    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Monitoring Service (Optional)
  monitoring:
    image: prom/prometheus:latest
    container_name: upsc-monitoring
    restart: unless-stopped
    
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    
    networks:
      - app-network

  # Log Aggregation (Optional)
  fluentd:
    image: fluent/fluentd:v1.16-debian-1
    container_name: upsc-fluentd
    restart: unless-stopped
    
    ports:
      - "${FLUENTD_PORT:-24224}:24224"
      - "${FLUENTD_PORT:-24224}:24224/udp"
    
    volumes:
      - ./fluentd/conf:/fluentd/etc
      - ./logs:/fluentd/log
    
    networks:
      - app-network
    
    # Environment Configuration
    environment:
      - FLUENTD_CONF=fluentd.conf

# Network Configuration
networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volume Configuration
volumes:
  redis-data:
    driver: local
  prometheus-data:
    driver: local

# =================================================================
# ENVIRONMENT VARIABLES CONFIGURATION
# =================================================================
# Create a .env file in the same directory with the following variables:
#
# # Application Configuration
# APP_PORT=3001
# NODE_ENV=production
# 
# # Redis Configuration
# REDIS_PORT=6379
# 
# # Monitoring Configuration
# PROMETHEUS_PORT=9090
# FLUENTD_PORT=24224
# 
# # Database Configuration (if using)
# POSTGRES_HOST=localhost
# POSTGRES_PORT=5432
# POSTGRES_DB=upsc_prepx_ai
# POSTGRES_USER=upsc_user
# POSTGRES_PASSWORD=your_secure_password
# 
# # MongoDB Configuration (if using)
# MONGO_HOST=localhost
# MONGO_PORT=27017
# MONGO_DB=upsc_prepx_ai
# 
# # Security Configuration
# JWT_SECRET=your_jwt_secret_key
# SESSION_SECRET=your_session_secret
# 
# # Email Configuration
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USER=your_email@gmail.com
# SMTP_PASS=your_app_password
# 
# # External API Keys
# OPENAI_API_KEY=your_openai_api_key
# ANTHROPIC_API_KEY=your_anthropic_api_key
# 
# # Application URLs
# BASE_URL=http://89.117.60.144:3001
# API_BASE_URL=http://89.117.60.144:3001/api
# 
# =================================================================
# USAGE INSTRUCTIONS
# =================================================================
# 
# 1. Environment Setup:
#    cp .env.example .env
#    # Edit .env with your configuration
# 
# 2. Basic Usage:
#    # Start all services
#    docker-compose up -d
#    
#    # Start only the main application
#    docker-compose up -d upsc-prepx-ai
#    
#    # Start with Redis
#    docker-compose up -d upsc-prepx-ai redis
# 
# 3. Management Commands:
#    # View logs
#    docker-compose logs -f upsc-prepx-ai
#    
#    # Restart service
#    docker-compose restart upsc-prepx-ai
#    
#    # Stop services
#    docker-compose down
#    
#    # Rebuild and restart
#    docker-compose up -d --build
# 
# 4. Health Checks:
#    # Check service health
#    docker-compose ps
#    
#    # Test health endpoint
#    curl http://localhost:3001/health
# 
# 5. Monitoring:
#    # Access Prometheus (if enabled)
#    http://localhost:9090
#    
#    # Check logs
#    docker-compose logs --tail=100 upsc-prepx-ai
# 
# 6. Backup and Recovery:
#    # Backup application data
#    docker-compose exec upsc-prepx-ai tar -czf /app/backups/backup-$(date +%Y%m%d).tar.gz /app/data
#    
#    # Restore from backup
#    docker-compose exec upsc-prepx-ai tar -xzf /app/backups/backup-20241230.tar.gz -C /
# 
# =================================================================
# PRODUCTION DEPLOYMENT NOTES
# =================================================================
# 
# 1. For production deployment, consider:
#    - Using external databases (PostgreSQL, MongoDB)
#    - Setting up SSL certificates for HTTPS
#    - Configuring nginx as reverse proxy
#    - Setting up monitoring and alerting
#    - Implementing backup strategies
# 
# 2. Security considerations:
#    - Change default passwords
#    - Use strong JWT secrets
#    - Configure proper firewall rules
#    - Enable fail2ban
#    - Regular security updates
# 
# 3. Performance optimization:
#    - Configure Redis for caching
#    - Set up CDN for static assets
#    - Optimize database queries
#    - Monitor resource usage
# 
# =================================================================
